var googleapi={setToken:function(e){localStorage.access_token=e.access_token,localStorage.refresh_token=e.refresh_token||localStorage.refresh_token;var o=(new Date).getTime()+1e3*parseInt(e.expires_in,10)-6e4;localStorage.expires_at=o},authorize:function(e){var o=$.Deferred(),t="https://accounts.google.com/o/oauth2/auth?"+$.param({client_id:e.client_id,redirect_uri:e.redirect_uri,response_type:"code",scope:e.scope}),n=window.open(t,"_blank","location=no,toolbar=no");return $(n).on("loadstart",function(t){var i=t.originalEvent.url,c=/\?code=(.+)$/.exec(i),r=/\?error=(.+)$/.exec(i);(c||r)&&n.close(),c?$.post("https://accounts.google.com/o/oauth2/token",{code:c[1],client_id:e.client_id,client_secret:e.client_secret,redirect_uri:e.redirect_uri,grant_type:"authorization_code"}).done(function(e){googleapi.setToken(e),o.resolve(e)}).fail(function(e){o.reject(e.responseJSON)}):r&&o.reject({error:r[1]})}),o.promise()},getToken:function(e){var o=$.Deferred();return(new Date).getTime()<localStorage.expires_at?o.resolve({access_token:localStorage.access_token}):localStorage.refresh_token?$.post("https://accounts.google.com/o/oauth2/token",{refresh_token:localStorage.refresh_token,client_id:e.client_id,client_secret:e.client_secret,grant_type:"refresh_token"}).done(function(e){googleapi.setToken(e),o.resolve(e)}).fail(function(e){o.reject(e.responseJSON)}):o.reject(),o.promise()},userInfo:function(e){return $.getJSON("https://www.googleapis.com/oauth2/v1/userinfo",e)}},app={client_id:"828831281117.apps.googleusercontent.com",client_secret:"xZrAvMkJAtFoFCU0ri3Nu7Rv",redirect_uri:"http://localhost",scope:"https://www.googleapis.com/auth/userinfo.profile",init:function(){$("#login").on("click",function(){app.onLoginButtonClick()}),googleapi.getToken({client_id:this.client_id,client_secret:this.client_secret}).done(function(){app.showGreetView()}).fail(function(){app.showLoginView()})},showLoginView:function(){$("#login").show(),$("#greet").hide()},showGreetView:function(){$("#login").hide(),$("#greet").show(),googleapi.getToken({client_id:this.client_id,client_secret:this.client_secret}).then(function(e){return googleapi.userInfo({access_token:e.access_token})}).done(function(e){$("#content").html("Hello "+e.name+"!")}).fail(function(){app.showLoginView()})},onLoginButtonClick:function(){googleapi.authorize({client_id:this.client_id,client_secret:this.client_secret,redirect_uri:this.redirect_uri,scope:this.scope}).done(function(){app.showGreetView()}).fail(function(e){$("#content").html(e.error)})}};app.init();